# Feature 2: Time Series Flight Data

Summarize what this does

![Historical Flight Data Aggregator](./images/historical-flight-data-aggregator.png)

## Data Model 

```sql
-- Create table for time series data
CREATE TABLE flight_data (
    flight_id VARCHAR(12) NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL,
    latitude DOUBLE PRECISION NOT NULL,
    longitude DOUBLE PRECISION NOT NULL,
    altitude INT NOT NULL,
    airspeed INT NOT NULL,

    PRIMARY KEY flight_id
);

-- Create table for metadata
CREATE TABLE flight_metadata (
    flight_id VARCHAR(12) NOT NULL,
    airline TEXT,
    flight_number TEXT,
    departure_airport TEXT,
    arrival_airport TEXT,

    PRIMARY KEY flight_id
);

-- Add TimescaleDB's hypertable functionality
SELECT create_hypertable('flight_data', 'timestamp');
```



#### 4.4 **Query and API Design**

- **API Endpoint**: `GET /api/flights/{flight_id}/timeseries?start=<timestamp>&end=<timestamp>`
  - **Request**: The client provides the flight ID and a time range.
  - **Response**: A time series of location, altitude, and airspeed data.

- **Graph Data API**:  
  - Pre-aggregated data (e.g., average altitude per minute) can be queried via the same API, providing data for visualization.

---




To store flight data into a TimescaleDB time-series database using Python, you would first need to translate the protobuf message schema into a corresponding SQL schema for TimescaleDB, and then create a Python script to insert the data.

### Step 1: SQL schema for TimescaleDB

Here's how you can create the necessary tables in PostgreSQL with TimescaleDB extensions to store the flight data as time-series data:


### Step 2: Python Code to Insert Flight Data

You can use the `psycopg2` library to interact with PostgreSQL and insert flight data. First, install the necessary dependencies:

```bash
pip install psycopg2 protobuf
```

Then, define the Python code that will parse the protobuf message and insert the data into the TimescaleDB database.

```python
import psycopg2
from google.protobuf.timestamp_pb2 import Timestamp
from flight_data_pb2 import FlightData  # Assuming you have generated the protobuf file

# PostgreSQL connection settings
conn = psycopg2.connect(
    dbname="your_db_name",
    user="your_username",
    password="your_password",
    host="localhost",
    port="5432"
)
cur = conn.cursor()

def insert_flight_data(flight_data: FlightData):
    # Extract the data from the protobuf message
    flight_id = flight_data.flight_id
    latitude = flight_data.location.latitude
    longitude = flight_data.location.longitude
    altitude = flight_data.altitude
    airspeed = flight_data.airspeed
    timestamp = flight_data.timestamp  # Should be in ISO 8601 or UNIX epoch format
    airline = flight_data.metadata.airline
    flight_number = flight_data.metadata.flight_number
    departure_airport = flight_data.metadata.departure_airport
    arrival_airport = flight_data.metadata.arrival_airport

    # Prepare SQL insert query
    query = """
    INSERT INTO flight_data (flight_id, latitude, longitude, altitude, airspeed, timestamp, airline, flight_number, departure_airport, arrival_airport)
    VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s);
    """

    # Insert the data into the database
    cur.execute(query, (
        flight_id, latitude, longitude, altitude, airspeed, timestamp, 
        airline, flight_number, departure_airport, arrival_airport
    ))
    conn.commit()

# Example of how to use the insert_flight_data function
# Create a sample FlightData protobuf message (assuming you have the generated class)
flight_data = FlightData(
    flight_id="ABC123",
    location=FlightData.Location(latitude=37.7749, longitude=-122.4194),
    altitude=35000,
    airspeed=500,
    timestamp="2024-10-04T12:34:56Z",  # ISO 8601 format
    metadata=FlightData.FlightMetadata(
        airline="SampleAir",
        flight_number="SA123",
        departure_airport="JFK",
        arrival_airport="LAX"
    )
)

# Insert the flight data into the database
insert_flight_data(flight_data)

# Close the connection when done
cur.close()
conn.close()
```

### Explanation:
1. **SQL Schema**: A table `flight_data` is created with appropriate columns to store flight details, including location, altitude, airspeed, timestamp, and metadata. We leverage TimescaleDB’s `create_hypertable` to optimize time-series storage.
2. **Protobuf Parsing**: The protobuf-generated classes (`FlightData`, `Location`, and `FlightMetadata`) are used to extract the required fields.
3. **Database Insertion**: The extracted data is inserted into the TimescaleDB table using a parameterized SQL `INSERT` query.

Make sure that you’ve already generated Python classes from your `.proto` files using the `protoc` compiler, and you’re using TimescaleDB for time-series optimizations.



