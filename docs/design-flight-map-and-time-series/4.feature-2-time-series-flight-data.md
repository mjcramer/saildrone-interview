# 4. Feature 2: Time Series Flight Data

Summarize what this does

![Historical Flight Data Aggregator](./images/historical-flight-data-aggregator.png)

## 4.1. Historical Flight Data Aggregator 

Data model

```sql
-- Create table for time series data
CREATE TABLE flight_data (
    flight_id VARCHAR(12) NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL,
    latitude DOUBLE PRECISION NOT NULL,
    longitude DOUBLE PRECISION NOT NULL,
    altitude INT NOT NULL,
    airspeed INT NOT NULL,

    PRIMARY KEY flight_id
);

-- Create table for metadata
CREATE TABLE flight_metadata (
    flight_id VARCHAR(12) NOT NULL,
    airline TEXT,
    flight_number TEXT,
    departure_airport TEXT,
    arrival_airport TEXT,

    PRIMARY KEY flight_id
);

-- Add TimescaleDB's hypertable functionality
SELECT create_hypertable('flight_data', 'timestamp');
```

## 4.2. Historical Flight Data API






To store flight data into a TimescaleDB time-series database using Python, you would first need to translate the protobuf message schema into a corresponding SQL schema for TimescaleDB, and then create a Python script to insert the data.


Here's how you can create the necessary tables in PostgreSQL with TimescaleDB extensions to store the flight data as time-series data:



You can use the `psycopg2` library to interact with PostgreSQL and insert flight data. First, install the necessary dependencies:

```bash
pip install psycopg2 protobuf
```

Then, define the Python code that will parse the protobuf message and insert the data into the TimescaleDB database.

```python
import psycopg2
from google.protobuf.timestamp_pb2 import Timestamp
from flight_data_pb2 import FlightData  # Assuming you have generated the protobuf file

# PostgreSQL connection settings
conn = psycopg2.connect(
    dbname="your_db_name",
    user="your_username",
    password="your_password",
    host="localhost",
    port="5432"
)
cur = conn.cursor()

def insert_flight_data(flight_data: FlightData):
    # Extract the data from the protobuf message
    flight_id = flight_data.flight_id
    latitude = flight_data.location.latitude
    longitude = flight_data.location.longitude
    altitude = flight_data.altitude
    airspeed = flight_data.airspeed
    timestamp = flight_data.timestamp  # Should be in ISO 8601 or UNIX epoch format
    airline = flight_data.metadata.airline
    flight_number = flight_data.metadata.flight_number
    departure_airport = flight_data.metadata.departure_airport
    arrival_airport = flight_data.metadata.arrival_airport

    # Prepare SQL insert query
    query = """
    INSERT INTO flight_data (flight_id, latitude, longitude, altitude, airspeed, timestamp, airline, flight_number, departure_airport, arrival_airport)
    VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s);
    """

    # Insert the data into the database
    cur.execute(query, (
        flight_id, latitude, longitude, altitude, airspeed, timestamp, 
        airline, flight_number, departure_airport, arrival_airport
    ))
    conn.commit()

# Example of how to use the insert_flight_data function
# Create a sample FlightData protobuf message (assuming you have the generated class)
flight_data = FlightData(
    flight_id="ABC123",
    location=FlightData.Location(latitude=37.7749, longitude=-122.4194),
    altitude=35000,
    airspeed=500,
    timestamp="2024-10-04T12:34:56Z",  # ISO 8601 format
    metadata=FlightData.FlightMetadata(
        airline="SampleAir",
        flight_number="SA123",
        departure_airport="JFK",
        arrival_airport="LAX"
    )
)

# Insert the flight data into the database
insert_flight_data(flight_data)

# Close the connection when done
cur.close()
conn.close()
```

### Explanation:
1. **SQL Schema**: A table `flight_data` is created with appropriate columns to store flight details, including location, altitude, airspeed, timestamp, and metadata. We leverage TimescaleDB’s `create_hypertable` to optimize time-series storage.
2. **Protobuf Parsing**: The protobuf-generated classes (`FlightData`, `Location`, and `FlightMetadata`) are used to extract the required fields.
3. **Database Insertion**: The extracted data is inserted into the TimescaleDB table using a parameterized SQL `INSERT` query.

Make sure that you’ve already generated Python classes from your `.proto` files using the `protoc` compiler, and you’re using TimescaleDB for time-series optimizations.


Got it! To implement a gRPC service that retrieves time-series flight data from TimescaleDB, you can use **gRPC** in Python along with `psycopg2` to interact with the PostgreSQL database.

Here’s a step-by-step guide for setting up a gRPC service:

### Step 1: Define the gRPC Service in a `.proto` File

You'll need to define the gRPC service that will retrieve the flight data time series based on `flight_id`. Here’s an updated `.proto` file:

```proto
syntax = "proto3";

package flight;

message FlightDataRequest {
  string flight_id = 1;
}

message FlightData {
  string flight_id = 1;
  double latitude = 2;
  double longitude = 3;
  int32 altitude = 4;
  int32 airspeed = 5;
  string timestamp = 6;  // ISO 8601 format or UNIX epoch time
  string airline = 7;
  string flight_number = 8;
  string departure_airport = 9;
  string arrival_airport = 10;
}

message FlightDataResponse {
  repeated FlightData flight_data = 1;
}

service FlightDataService {
  rpc GetFlightData(FlightDataRequest) returns (FlightDataResponse);
}
```

### Step 2: Generate Python Code from the `.proto` File

Run the `protoc` command to generate the Python classes and gRPC stubs from the `.proto` file. Make sure you have `grpcio-tools` installed:

```bash
pip install grpcio-tools
```

Generate the code:

```bash
python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. flight_data.proto
```

This will generate two files: `flight_data_pb2.py` and `flight_data_pb2_grpc.py`, which contain the message classes and the service definition stubs.

### Step 3: Implement the gRPC Server in Python

Next, you can implement the gRPC server that connects to TimescaleDB and serves the time series data.

```python
import grpc
from concurrent import futures
import psycopg2
from flight_data_pb2 import FlightData, FlightDataResponse
import flight_data_pb2_grpc

# PostgreSQL connection settings
conn = psycopg2.connect(
    dbname="your_db_name",
    user="your_username",
    password="your_password",
    host="localhost",
    port="5432"
)

# Flight Data Service class implementation
class FlightDataService(flight_data_pb2_grpc.FlightDataServiceServicer):
    def GetFlightData(self, request, context):
        flight_id = request.flight_id

        try:
            cur = conn.cursor()
            query = """
            SELECT flight_id, latitude, longitude, altitude, airspeed, timestamp, airline, flight_number, departure_airport, arrival_airport
            FROM flight_data
            WHERE flight_id = %s
            ORDER BY timestamp;
            """
            cur.execute(query, (flight_id,))
            rows = cur.fetchall()

            if not rows:
                context.set_details("Flight not found")
                context.set_code(grpc.StatusCode.NOT_FOUND)
                return FlightDataResponse()

            flight_data_list = [
                FlightData(
                    flight_id=row[0],
                    latitude=row[1],
                    longitude=row[2],
                    altitude=row[3],
                    airspeed=row[4],
                    timestamp=row[5].isoformat(),  # Assuming timestamp is returned in UTC
                    airline=row[6],
                    flight_number=row[7],
                    departure_airport=row[8],
                    arrival_airport=row[9]
                )
                for row in rows
            ]

            return FlightDataResponse(flight_data=flight_data_list)

        except Exception as e:
            context.set_details(f"Internal error: {str(e)}")
            context.set_code(grpc.StatusCode.INTERNAL)
            return FlightDataResponse()

# Start the gRPC server
def serve():
    server = grpc.server(futures.ThreadPoolExecutor(max_workers=10))
    flight_data_pb2_grpc.add_FlightDataServiceServicer_to_server(FlightDataService(), server)
    server.add_insecure_port('[::]:50051')
    server.start()
    print("gRPC server running on port 50051...")
    server.wait_for_termination()

if __name__ == "__main__":
    serve()
```

### Step 4: Implement the gRPC Client in Python

Here's how you can implement a gRPC client to request flight data from the server:

```python
import grpc
import flight_data_pb2
import flight_data_pb2_grpc

def run():
    with grpc.insecure_channel('localhost:50051') as channel:
        stub = flight_data_pb2_grpc.FlightDataServiceStub(channel)
        request = flight_data_pb2.FlightDataRequest(flight_id="ABC123")
        response = stub.GetFlightData(request)

        if response.flight_data:
            for flight in response.flight_data:
                print(f"Flight ID: {flight.flight_id}")
                print(f"Location: {flight.latitude}, {flight.longitude}")
                print(f"Altitude: {flight.altitude} feet")
                print(f"Airspeed: {flight.airspeed} knots")
                print(f"Timestamp: {flight.timestamp}")
                print(f"Airline: {flight.airline}")
                print(f"Flight Number: {flight.flight_number}")
                print(f"Departure: {flight.departure_airport}")
                print(f"Arrival: {flight.arrival_airport}")
                print("-" * 20)
        else:
            print("No flight data found.")

if __name__ == "__main__":
    run()
```

### Step 5: Running the gRPC Server and Client

1. **Run the gRPC server**:

```bash
python server.py
```

2. **Run the gRPC client** to make a request for flight data:

```bash
python client.py
```

### Explanation of the Code:

1. **Server**:
   - The `FlightDataServiceServicer` class implements the gRPC service defined in the `.proto` file.
   - `GetFlightData` retrieves the flight data time series from the TimescaleDB table and returns it as a `FlightDataResponse`.
   - The server starts on port `50051` and waits for incoming gRPC requests.

2. **Client**:
   - The client connects to the gRPC server, makes a `FlightDataRequest` with the flight ID, and retrieves the time series data.
   - The response is printed, showing all data points for the requested flight.

This setup allows you to retrieve flight data via gRPC, making it more efficient and suited for systems where you need low-latency communication over HTTP alternatives like REST.




## 4.3. Cleaner